emulate -L zsh
.lzsh_preflight_check || return 1

local buffer_context="$BUFFER"
local cursor_position=$CURSOR

# push new history file before reading command
fc -ap "${HISTFILE%.lazyshell*}.lazyshell-complete"

# Read user input
# Todo: use zle to read input
local REPLY
autoload -Uz read-from-minibuffer
read-from-minibuffer '> Query: '
BUFFER="$buffer_context"
CURSOR=$cursor_position

if [[ -z $REPLY ]]; then
  # silently return if user quit with buffer empty
  return 1
fi

# Save query to lazyshell history
print -rs - "$REPLY"

local os
.lzsh_get_distribution_name os
local intro="You are a zsh autocomplete script. All your answers are a single command${os:+ for $os}, and nothing else. You do not write any human-readable explanations. If you fail to answer, start your response with \`#\`."
if [[ -z "$buffer_context" ]]; then
  local prompt="$REPLY"
else
  local prompt="Alter zsh command \`$buffer_context\` to comply with query \`$REPLY\`"
fi

.lzsh_llm_api_call "$intro" "$prompt" "Query: $REPLY"
if [ $? -ne 0 ]; then
  return 1
fi

# if response starts with '#' it means GPT failed to generate the command
if [[ "$generated_text" == \#* ]]; then
  zle -M "$generated_text"
  return 1
fi

# Replace the current buffer with the generated text
BUFFER="$generated_text"
CURSOR=$#BUFFER

